<?xml version="1.0" encoding="UTF-8"?><record_update sys_domain="global" table="sys_hub_action_type_definition">
    <sys_hub_action_type_definition action="INSERT_OR_UPDATE">
        <access>public</access>
        <acls/>
        <action_template/>
        <active>true</active>
        <annotation/>
        <callable_by_client_api>false</callable_by_client_api>
        <category/>
        <copied_from/>
        <copied_from_name/>
        <description/>
        <ih_action>false</ih_action>
        <internal_name>worker_poll_destroy_workspace</internal_name>
        <label_cache>[{"name":"{{action.tf_record}}","label":"action➛tf_record","type":"action","ref":""}]</label_cache>
        <latest_snapshot>38e06d822f903010d881309cf699b6cc</latest_snapshot>
        <master_snapshot>a9a376e3db99581038699d67b996190d</master_snapshot>
        <name>Worker Poll Destroy Workspace</name>
        <natlang/>
        <outputs/>
        <state>published</state>
        <sys_class_name>sys_hub_action_type_definition</sys_class_name>
        <sys_created_by>pwelch</sys_created_by>
        <sys_created_on>2020-06-15 20:30:40</sys_created_on>
        <sys_domain>global</sys_domain>
        <sys_domain_path>/</sys_domain_path>
        <sys_id>4e6332e3db99581038699d67b99619e2</sys_id>
        <sys_mod_count>20</sys_mod_count>
        <sys_name>Worker Poll Destroy Workspace</sys_name>
        <sys_overrides/>
        <sys_package display_value="Terraform" source="x_325709_terraform">a3f7fe62dbe033009ba2f8fdbf96192a</sys_package>
        <sys_policy/>
        <sys_scope display_value="Terraform">a3f7fe62dbe033009ba2f8fdbf96192a</sys_scope>
        <sys_update_name>sys_hub_action_type_definition_4e6332e3db99581038699d67b99619e2</sys_update_name>
        <sys_updated_by>pwelch</sys_updated_by>
        <sys_updated_on>2020-06-17 01:49:14</sys_updated_on>
        <system_level>false</system_level>
        <type/>
    </sys_hub_action_type_definition>
    <sys_translated_text action="delete_multiple" query="documentkey=4e6332e3db99581038699d67b99619e2"/>
    <sys_variable_value action="delete_multiple" query="document_key=4e6332e3db99581038699d67b99619e2"/>
    <sys_hub_step_instance action="delete_multiple" query="action=4e6332e3db99581038699d67b99619e2^sys_idNOT INbf93f2e3db99581038699d67b99619fd"/>
    <sys_hub_step_instance action="INSERT_OR_UPDATE">
        <action display_value="Worker Poll Destroy Workspace">4e6332e3db99581038699d67b99619e2</action>
        <cid>fa882b48-7ce6-4ebe-be67-abf2115bd35a</cid>
        <extended_inputs/>
        <extended_inputs/>
        <extended_outputs/>
        <icon/>
        <inputs/>
        <label>Script step</label>
        <order>1</order>
        <outputs/>
        <section/>
        <step_type display_value="Script">106afb6647032200b4fad7527c9a71e7</step_type>
        <sys_created_by>pwelch</sys_created_by>
        <sys_created_on>2020-06-15 20:31:36</sys_created_on>
        <sys_id>bf93f2e3db99581038699d67b99619fd</sys_id>
        <sys_mod_count>4</sys_mod_count>
        <sys_scope display_value="Terraform">a3f7fe62dbe033009ba2f8fdbf96192a</sys_scope>
        <sys_updated_by>pwelch</sys_updated_by>
        <sys_updated_on>2020-06-17 01:49:11</sys_updated_on>
    </sys_hub_step_instance>
    <sys_variable_value action="delete_multiple" query="document_key=bf93f2e3db99581038699d67b99619fd"/>
    <sys_variable_value action="INSERT_OR_UPDATE">
        <document>sys_hub_step_instance</document>
        <document_key>bf93f2e3db99581038699d67b99619fd</document_key>
        <order>600</order>
        <sys_class_name>sys_variable_value</sys_class_name>
        <sys_created_by>pwelch</sys_created_by>
        <sys_created_on>2020-06-15 20:31:37</sys_created_on>
        <sys_id>04a336e3db99581038699d67b996190a</sys_id>
        <sys_mod_count>3</sys_mod_count>
        <sys_updated_by>pwelch</sys_updated_by>
        <sys_updated_on>2020-06-17 01:49:11</sys_updated_on>
        <value>(function execute(inputs, outputs) {
/*
  Poll Destroy Workspace
    Finds any records marked where is-destroyable = true and
    sends the destroy API requests to Terraform

    The "Delete Workspace" example flow catalog item will set the is_destroyable
    value, then create a terraform destroy plan.
    This flow will then check the state of the planning workspace.
    If it's done planning, it will apply the destroy run.
    If it's done applying the destroy run, it will delete the workspace from Terraform.
*/

gs.info("Polling Flow: terraform delete workspace started...");

// Input Variables
var tfRecord = inputs.tf_record;

// Create new objects from Terraform API SDK
var terraformRecord  = new tf_terraform_record();
var run              = new tf_run();
var workspace        = new tf_workspace();
var util             = new tf_util();

var tfCurrentRun = workspace.getWorkspaceCurrentRun(tfRecord.workspace_name);
  
if (tfCurrentRun !== null) {
  if (run.isDestroyRun(tfCurrentRun.id) !== "false") {
    var tfRunState   = run.getRunState(tfCurrentRun.id).toLowerCase();
    var comment = "";

    switch (tfRunState) {
      case "planning":
        // no-op: move on until it's done
        break;

      case "planned":
        /* Apply Run */
        // If the destroy run is finished planning, we can confirm and apply the destroy run.
        var applyContent = run.createRunRequestContent(workspaceID, "Destroy triggered by scheduler");
        var requestJSON  = JSON.stringify(applyContent);

        var http = new tf_http("TF Runs", "Apply Run", requestJSON);
        http.setParam("run_id", String(tfCurrentRun.id));
        http.execute();

        tfRecord.last_known_state = "destroy_applying";
        tfRecord.update();
        comment = util.formatCommentBlockQuote("Terraform: destroy run applying");
        break;

      case "applied": case "planned_and_finished":
        /* Delete Workspace */
        // The destroy run removing all resources managed by terraform is complete so we can delete the workspace.
        // HTTP REST request to Terraform Workspace API
        var httpWorkspace = new tf_http("TF Workspaces", "Delete Workspace", null);
        httpWorkspace.setParam("workspace_name", String(tfRecord.workspace_name));
        httpWorkspace.execute();

        tfRecord.last_known_state = "deleted";
        tfRecord.update();
        comment = util.formatCommentBlockQuote("Terraform: Workspace Deleted");
        break;

      case "applying":
        // no-op: move on until it's done
        break;

      case "discarded": case "errored": case "canceled":
        tfRecord.last_known_state = "errored";
        tfRecord.is_destroyable   = false;
        tfRecord.update();
        comment = util.formatCommentBlockQuote("Terraform: destroy error, resetting to not destroyable");
        break;
    }
    
    terraformRecord.postRITMComment(tfRecord.requested_item, comment);
  }
}
  
gs.info("Polling Flow: terraform delete workspace finished.");

})(inputs, outputs);
</value>
        <variable display_value="">71aa7f6647032200b4fad7527c9a719b</variable>
    </sys_variable_value>
    <sys_variable_value action="INSERT_OR_UPDATE">
        <document>sys_hub_step_instance</document>
        <document_key>bf93f2e3db99581038699d67b99619fd</document_key>
        <order>400</order>
        <sys_class_name>sys_variable_value</sys_class_name>
        <sys_created_by>pwelch</sys_created_by>
        <sys_created_on>2020-06-15 20:31:37</sys_created_on>
        <sys_id>40a336e3db99581038699d67b996190a</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_updated_by>pwelch</sys_updated_by>
        <sys_updated_on>2020-06-15 20:31:37</sys_updated_on>
        <value>35aa573fd7802200bdbaee5b5e610375</value>
        <variable display_value="">f5e56d79b3101300176b051a16a8dce4</variable>
    </sys_variable_value>
    <sys_element_mapping action="delete_multiple" query="id=bf93f2e3db99581038699d67b99619fd"/>
    <sys_element_mapping action="INSERT_OR_UPDATE">
        <field>application</field>
        <id>bf93f2e3db99581038699d67b99619fd</id>
        <sys_created_by>pwelch</sys_created_by>
        <sys_created_on>2020-06-15 20:31:37</sys_created_on>
        <sys_id>0ca336e3db99581038699d67b9961909</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_updated_by>pwelch</sys_updated_by>
        <sys_updated_on>2020-06-15 20:31:37</sys_updated_on>
        <table>var__m_sys_flow_step_definition_input_106afb6647032200b4fad7527c9a71e7</table>
        <value/>
    </sys_element_mapping>
    <sys_element_mapping action="INSERT_OR_UPDATE">
        <field>script</field>
        <id>bf93f2e3db99581038699d67b99619fd</id>
        <sys_created_by>pwelch</sys_created_by>
        <sys_created_on>2020-06-15 20:31:37</sys_created_on>
        <sys_id>cca336e3db99581038699d67b9961909</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_updated_by>pwelch</sys_updated_by>
        <sys_updated_on>2020-06-15 20:31:37</sys_updated_on>
        <table>var__m_sys_flow_step_definition_input_106afb6647032200b4fad7527c9a71e7</table>
        <value/>
    </sys_element_mapping>
    <sys_element_mapping action="INSERT_OR_UPDATE">
        <field>tf_record</field>
        <id>bf93f2e3db99581038699d67b99619fd</id>
        <sys_created_by>pwelch</sys_created_by>
        <sys_created_on>2020-06-15 20:31:37</sys_created_on>
        <sys_id>48a336e3db99581038699d67b9961917</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_updated_by>pwelch</sys_updated_by>
        <sys_updated_on>2020-06-15 20:31:37</sys_updated_on>
        <table>var__m_sys_hub_step_ext_input_bf93f2e3db99581038699d67b99619fd</table>
        <value>{{action.tf_record}}</value>
    </sys_element_mapping>
    <sys_hub_step_ext_input action="delete_multiple" query="model=bf93f2e3db99581038699d67b99619fd^sys_idNOT INff9336e3db99581038699d67b9961901"/>
    <sys_hub_step_ext_input action="INSERT_OR_UPDATE">
        <active>true</active>
        <array>false</array>
        <array_denormalized>false</array_denormalized>
        <attributes>element_mapping_provider=com.glide.flow_design.action.data.FlowDesignVariableMapper,uiType=string</attributes>
        <audit>false</audit>
        <calculation><![CDATA[(function calculatedFieldValue(current) {

	// Add your code here
	return '';  // return the calculated value

})(current);]]></calculation>
        <choice/>
        <choice_field/>
        <choice_table/>
        <column_label/>
        <comments/>
        <create_roles/>
        <default_value/>
        <defaultsort/>
        <delete_roles/>
        <dependent/>
        <dependent_on_field/>
        <display>false</display>
        <dynamic_creation>false</dynamic_creation>
        <dynamic_creation_script/>
        <dynamic_default_value/>
        <dynamic_ref_qual/>
        <element>tf_record</element>
        <element_reference>false</element_reference>
        <foreign_database/>
        <function_definition/>
        <function_field>false</function_field>
        <help/>
        <hint/>
        <internal_type display_value="String">string</internal_type>
        <label/>
        <mandatory>true</mandatory>
        <max_length>8000</max_length>
        <model display_value="Script step">bf93f2e3db99581038699d67b99619fd</model>
        <model_id>bf93f2e3db99581038699d67b99619fd</model_id>
        <model_table>sys_hub_step_instance</model_table>
        <name>var__m_sys_hub_step_ext_input_bf93f2e3db99581038699d67b99619fd</name>
        <next_element/>
        <order>0</order>
        <primary>false</primary>
        <read_only>false</read_only>
        <read_roles/>
        <reference/>
        <reference_cascade_rule/>
        <reference_floats>false</reference_floats>
        <reference_key/>
        <reference_qual/>
        <reference_qual_condition/>
        <reference_type/>
        <sizeclass/>
        <spell_check>false</spell_check>
        <staged>false</staged>
        <sys_class_name>sys_hub_step_ext_input</sys_class_name>
        <sys_created_by>pwelch</sys_created_by>
        <sys_created_on>2020-06-15 20:31:36</sys_created_on>
        <sys_id>ff9336e3db99581038699d67b9961901</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_name/>
        <sys_package/>
        <sys_policy/>
        <sys_scope display_value="Terraform">a3f7fe62dbe033009ba2f8fdbf96192a</sys_scope>
        <sys_update_name/>
        <sys_updated_by>pwelch</sys_updated_by>
        <sys_updated_on>2020-06-15 20:31:36</sys_updated_on>
        <table_reference>false</table_reference>
        <text_index>false</text_index>
        <unique>false</unique>
        <use_dependent_field>false</use_dependent_field>
        <use_dynamic_default>false</use_dynamic_default>
        <use_reference_qualifier>simple</use_reference_qualifier>
        <virtual>false</virtual>
        <widget/>
        <write_roles/>
        <xml_view>false</xml_view>
    </sys_hub_step_ext_input>
    <sys_hub_action_input action="delete_multiple" query="model=4e6332e3db99581038699d67b99619e2^sys_idNOT INbb93f2e3db99581038699d67b99619f4"/>
    <sys_hub_action_input action="INSERT_OR_UPDATE">
        <active>true</active>
        <array>false</array>
        <array_denormalized>false</array_denormalized>
        <attributes>element_mapping_provider=com.glide.flow_design.action.data.FlowDesignVariableMapper,uiType=string,uiTypeLabel=String</attributes>
        <audit>false</audit>
        <calculation><![CDATA[(function calculatedFieldValue(current) {

	// Add your code here
	return '';  // return the calculated value

})(current);]]></calculation>
        <choice/>
        <choice_field/>
        <choice_table/>
        <column_label/>
        <comments/>
        <create_roles/>
        <default_value/>
        <defaultsort/>
        <delete_roles/>
        <dependent/>
        <dependent_on_field/>
        <display>false</display>
        <dynamic_creation>false</dynamic_creation>
        <dynamic_creation_script/>
        <dynamic_default_value/>
        <dynamic_ref_qual/>
        <element>tf_record</element>
        <element_reference>false</element_reference>
        <foreign_database/>
        <function_definition/>
        <function_field>false</function_field>
        <help/>
        <hint/>
        <internal_type display_value="String">string</internal_type>
        <label>tf_record</label>
        <mandatory>false</mandatory>
        <max_length>8000</max_length>
        <model display_value="Worker Poll Destroy Workspace">4e6332e3db99581038699d67b99619e2</model>
        <model_id>4e6332e3db99581038699d67b99619e2</model_id>
        <model_table>sys_hub_action_type_definition</model_table>
        <name>var__m_sys_hub_action_input_4e6332e3db99581038699d67b99619e2</name>
        <next_element/>
        <order>1</order>
        <primary>false</primary>
        <read_only>false</read_only>
        <read_roles/>
        <reference/>
        <reference_cascade_rule/>
        <reference_floats>false</reference_floats>
        <reference_key/>
        <reference_qual/>
        <reference_qual_condition/>
        <reference_type/>
        <sizeclass/>
        <spell_check>false</spell_check>
        <staged>false</staged>
        <sys_class_name>sys_hub_action_input</sys_class_name>
        <sys_created_by>pwelch</sys_created_by>
        <sys_created_on>2020-06-15 20:31:36</sys_created_on>
        <sys_id>bb93f2e3db99581038699d67b99619f4</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_name/>
        <sys_package/>
        <sys_policy/>
        <sys_scope display_value="Terraform">a3f7fe62dbe033009ba2f8fdbf96192a</sys_scope>
        <sys_update_name/>
        <sys_updated_by>pwelch</sys_updated_by>
        <sys_updated_on>2020-06-15 20:31:36</sys_updated_on>
        <table_reference>false</table_reference>
        <text_index>false</text_index>
        <unique>false</unique>
        <use_dependent_field>false</use_dependent_field>
        <use_dynamic_default>false</use_dynamic_default>
        <use_reference_qualifier>simple</use_reference_qualifier>
        <virtual>false</virtual>
        <widget/>
        <write_roles/>
        <xml_view>false</xml_view>
    </sys_hub_action_input>
    <sys_hub_step_instance action="delete_multiple" query="action=4e6332e3db99581038699d67b99619e2^sys_idNOT INbf93f2e3db99581038699d67b99619fd"/>
    <sys_hub_step_instance action="INSERT_OR_UPDATE">
        <action display_value="Worker Poll Destroy Workspace">4e6332e3db99581038699d67b99619e2</action>
        <cid>fa882b48-7ce6-4ebe-be67-abf2115bd35a</cid>
        <extended_inputs/>
        <extended_inputs/>
        <extended_outputs/>
        <icon/>
        <inputs/>
        <label>Script step</label>
        <order>1</order>
        <outputs/>
        <section/>
        <step_type display_value="Script">106afb6647032200b4fad7527c9a71e7</step_type>
        <sys_created_by>pwelch</sys_created_by>
        <sys_created_on>2020-06-15 20:31:36</sys_created_on>
        <sys_id>bf93f2e3db99581038699d67b99619fd</sys_id>
        <sys_mod_count>4</sys_mod_count>
        <sys_scope display_value="Terraform">a3f7fe62dbe033009ba2f8fdbf96192a</sys_scope>
        <sys_updated_by>pwelch</sys_updated_by>
        <sys_updated_on>2020-06-17 01:49:11</sys_updated_on>
    </sys_hub_step_instance>
    <sys_variable_value action="delete_multiple" query="document_key=bf93f2e3db99581038699d67b99619fd"/>
    <sys_variable_value action="INSERT_OR_UPDATE">
        <document>sys_hub_step_instance</document>
        <document_key>bf93f2e3db99581038699d67b99619fd</document_key>
        <order>600</order>
        <sys_class_name>sys_variable_value</sys_class_name>
        <sys_created_by>pwelch</sys_created_by>
        <sys_created_on>2020-06-15 20:31:37</sys_created_on>
        <sys_id>04a336e3db99581038699d67b996190a</sys_id>
        <sys_mod_count>3</sys_mod_count>
        <sys_updated_by>pwelch</sys_updated_by>
        <sys_updated_on>2020-06-17 01:49:11</sys_updated_on>
        <value>(function execute(inputs, outputs) {
/*
  Poll Destroy Workspace
    Finds any records marked where is-destroyable = true and
    sends the destroy API requests to Terraform

    The "Delete Workspace" example flow catalog item will set the is_destroyable
    value, then create a terraform destroy plan.
    This flow will then check the state of the planning workspace.
    If it's done planning, it will apply the destroy run.
    If it's done applying the destroy run, it will delete the workspace from Terraform.
*/

gs.info("Polling Flow: terraform delete workspace started...");

// Input Variables
var tfRecord = inputs.tf_record;

// Create new objects from Terraform API SDK
var terraformRecord  = new tf_terraform_record();
var run              = new tf_run();
var workspace        = new tf_workspace();
var util             = new tf_util();

var tfCurrentRun = workspace.getWorkspaceCurrentRun(tfRecord.workspace_name);
  
if (tfCurrentRun !== null) {
  if (run.isDestroyRun(tfCurrentRun.id) !== "false") {
    var tfRunState   = run.getRunState(tfCurrentRun.id).toLowerCase();
    var comment = "";

    switch (tfRunState) {
      case "planning":
        // no-op: move on until it's done
        break;

      case "planned":
        /* Apply Run */
        // If the destroy run is finished planning, we can confirm and apply the destroy run.
        var applyContent = run.createRunRequestContent(workspaceID, "Destroy triggered by scheduler");
        var requestJSON  = JSON.stringify(applyContent);

        var http = new tf_http("TF Runs", "Apply Run", requestJSON);
        http.setParam("run_id", String(tfCurrentRun.id));
        http.execute();

        tfRecord.last_known_state = "destroy_applying";
        tfRecord.update();
        comment = util.formatCommentBlockQuote("Terraform: destroy run applying");
        break;

      case "applied": case "planned_and_finished":
        /* Delete Workspace */
        // The destroy run removing all resources managed by terraform is complete so we can delete the workspace.
        // HTTP REST request to Terraform Workspace API
        var httpWorkspace = new tf_http("TF Workspaces", "Delete Workspace", null);
        httpWorkspace.setParam("workspace_name", String(tfRecord.workspace_name));
        httpWorkspace.execute();

        tfRecord.last_known_state = "deleted";
        tfRecord.update();
        comment = util.formatCommentBlockQuote("Terraform: Workspace Deleted");
        break;

      case "applying":
        // no-op: move on until it's done
        break;

      case "discarded": case "errored": case "canceled":
        tfRecord.last_known_state = "errored";
        tfRecord.is_destroyable   = false;
        tfRecord.update();
        comment = util.formatCommentBlockQuote("Terraform: destroy error, resetting to not destroyable");
        break;
    }
    
    terraformRecord.postRITMComment(tfRecord.requested_item, comment);
  }
}
  
gs.info("Polling Flow: terraform delete workspace finished.");

})(inputs, outputs);
</value>
        <variable display_value="">71aa7f6647032200b4fad7527c9a719b</variable>
    </sys_variable_value>
    <sys_variable_value action="INSERT_OR_UPDATE">
        <document>sys_hub_step_instance</document>
        <document_key>bf93f2e3db99581038699d67b99619fd</document_key>
        <order>400</order>
        <sys_class_name>sys_variable_value</sys_class_name>
        <sys_created_by>pwelch</sys_created_by>
        <sys_created_on>2020-06-15 20:31:37</sys_created_on>
        <sys_id>40a336e3db99581038699d67b996190a</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_updated_by>pwelch</sys_updated_by>
        <sys_updated_on>2020-06-15 20:31:37</sys_updated_on>
        <value>35aa573fd7802200bdbaee5b5e610375</value>
        <variable display_value="">f5e56d79b3101300176b051a16a8dce4</variable>
    </sys_variable_value>
    <sys_element_mapping action="delete_multiple" query="id=bf93f2e3db99581038699d67b99619fd"/>
    <sys_element_mapping action="INSERT_OR_UPDATE">
        <field>application</field>
        <id>bf93f2e3db99581038699d67b99619fd</id>
        <sys_created_by>pwelch</sys_created_by>
        <sys_created_on>2020-06-15 20:31:37</sys_created_on>
        <sys_id>0ca336e3db99581038699d67b9961909</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_updated_by>pwelch</sys_updated_by>
        <sys_updated_on>2020-06-15 20:31:37</sys_updated_on>
        <table>var__m_sys_flow_step_definition_input_106afb6647032200b4fad7527c9a71e7</table>
        <value/>
    </sys_element_mapping>
    <sys_element_mapping action="INSERT_OR_UPDATE">
        <field>script</field>
        <id>bf93f2e3db99581038699d67b99619fd</id>
        <sys_created_by>pwelch</sys_created_by>
        <sys_created_on>2020-06-15 20:31:37</sys_created_on>
        <sys_id>cca336e3db99581038699d67b9961909</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_updated_by>pwelch</sys_updated_by>
        <sys_updated_on>2020-06-15 20:31:37</sys_updated_on>
        <table>var__m_sys_flow_step_definition_input_106afb6647032200b4fad7527c9a71e7</table>
        <value/>
    </sys_element_mapping>
    <sys_element_mapping action="INSERT_OR_UPDATE">
        <field>tf_record</field>
        <id>bf93f2e3db99581038699d67b99619fd</id>
        <sys_created_by>pwelch</sys_created_by>
        <sys_created_on>2020-06-15 20:31:37</sys_created_on>
        <sys_id>48a336e3db99581038699d67b9961917</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_updated_by>pwelch</sys_updated_by>
        <sys_updated_on>2020-06-15 20:31:37</sys_updated_on>
        <table>var__m_sys_hub_step_ext_input_bf93f2e3db99581038699d67b99619fd</table>
        <value>{{action.tf_record}}</value>
    </sys_element_mapping>
    <sys_hub_step_ext_input action="delete_multiple" query="model=bf93f2e3db99581038699d67b99619fd^sys_idNOT INff9336e3db99581038699d67b9961901"/>
    <sys_hub_step_ext_input action="INSERT_OR_UPDATE">
        <active>true</active>
        <array>false</array>
        <array_denormalized>false</array_denormalized>
        <attributes>element_mapping_provider=com.glide.flow_design.action.data.FlowDesignVariableMapper,uiType=string</attributes>
        <audit>false</audit>
        <calculation><![CDATA[(function calculatedFieldValue(current) {

	// Add your code here
	return '';  // return the calculated value

})(current);]]></calculation>
        <choice/>
        <choice_field/>
        <choice_table/>
        <column_label/>
        <comments/>
        <create_roles/>
        <default_value/>
        <defaultsort/>
        <delete_roles/>
        <dependent/>
        <dependent_on_field/>
        <display>false</display>
        <dynamic_creation>false</dynamic_creation>
        <dynamic_creation_script/>
        <dynamic_default_value/>
        <dynamic_ref_qual/>
        <element>tf_record</element>
        <element_reference>false</element_reference>
        <foreign_database/>
        <function_definition/>
        <function_field>false</function_field>
        <help/>
        <hint/>
        <internal_type display_value="String">string</internal_type>
        <label/>
        <mandatory>true</mandatory>
        <max_length>8000</max_length>
        <model display_value="Script step">bf93f2e3db99581038699d67b99619fd</model>
        <model_id>bf93f2e3db99581038699d67b99619fd</model_id>
        <model_table>sys_hub_step_instance</model_table>
        <name>var__m_sys_hub_step_ext_input_bf93f2e3db99581038699d67b99619fd</name>
        <next_element/>
        <order>0</order>
        <primary>false</primary>
        <read_only>false</read_only>
        <read_roles/>
        <reference/>
        <reference_cascade_rule/>
        <reference_floats>false</reference_floats>
        <reference_key/>
        <reference_qual/>
        <reference_qual_condition/>
        <reference_type/>
        <sizeclass/>
        <spell_check>false</spell_check>
        <staged>false</staged>
        <sys_class_name>sys_hub_step_ext_input</sys_class_name>
        <sys_created_by>pwelch</sys_created_by>
        <sys_created_on>2020-06-15 20:31:36</sys_created_on>
        <sys_id>ff9336e3db99581038699d67b9961901</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_name/>
        <sys_package/>
        <sys_policy/>
        <sys_scope display_value="Terraform">a3f7fe62dbe033009ba2f8fdbf96192a</sys_scope>
        <sys_update_name/>
        <sys_updated_by>pwelch</sys_updated_by>
        <sys_updated_on>2020-06-15 20:31:36</sys_updated_on>
        <table_reference>false</table_reference>
        <text_index>false</text_index>
        <unique>false</unique>
        <use_dependent_field>false</use_dependent_field>
        <use_dynamic_default>false</use_dynamic_default>
        <use_reference_qualifier>simple</use_reference_qualifier>
        <virtual>false</virtual>
        <widget/>
        <write_roles/>
        <xml_view>false</xml_view>
    </sys_hub_step_ext_input>
    <sys_documentation action="delete_multiple" query="name=var__m_sys_hub_action_input_4e6332e3db99581038699d67b99619e2^sys_idNOT IN7f93f2e3db99581038699d67b99619fb"/>
    <sys_documentation action="INSERT_OR_UPDATE">
        <element>tf_record</element>
        <help/>
        <hint/>
        <label>tf_record</label>
        <language>en</language>
        <name>var__m_sys_hub_action_input_4e6332e3db99581038699d67b99619e2</name>
        <plural/>
        <sys_class_name>sys_documentation</sys_class_name>
        <sys_created_by>pwelch</sys_created_by>
        <sys_created_on>2020-06-15 20:31:36</sys_created_on>
        <sys_id>7f93f2e3db99581038699d67b99619fb</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_name>tf_record</sys_name>
        <sys_package display_value="Terraform" source="x_325709_terraform">a3f7fe62dbe033009ba2f8fdbf96192a</sys_package>
        <sys_policy/>
        <sys_scope display_value="Terraform">a3f7fe62dbe033009ba2f8fdbf96192a</sys_scope>
        <sys_update_name>sys_documentation_var__m_sys_hub_action_input_4e6332e3db99581038699d67b99619e2_tf_record_en</sys_update_name>
        <sys_updated_by>pwelch</sys_updated_by>
        <sys_updated_on>2020-06-15 20:31:36</sys_updated_on>
        <url/>
        <url_target/>
    </sys_documentation>
    <sys_hub_action_plan action="delete_multiple" query="action_id=4e6332e3db99581038699d67b99619e2^sys_idNOT INe5a376e3db99581038699d67b9961955"/>
    <sys_hub_action_plan action="INSERT_OR_UPDATE">
        <action_id display_value="Worker Poll Destroy Workspace">4e6332e3db99581038699d67b99619e2</action_id>
        <plan>{"persistor":{"@class":".ChunkingPlanPersistor","table":"sys_hub_action_plan","id":"e5a376e3db99581038699d67b9961955","name":"plan"}}</plan>
        <snapshot>5ee58500dbed981038699d67b99619cc</snapshot>
        <sys_created_by>pwelch</sys_created_by>
        <sys_created_on>2020-06-15 20:31:44</sys_created_on>
        <sys_domain>global</sys_domain>
        <sys_domain_path>/</sys_domain_path>
        <sys_id>e5a376e3db99581038699d67b9961955</sys_id>
        <sys_mod_count>3</sys_mod_count>
        <sys_overrides/>
        <sys_scope/>
        <sys_updated_by>pwelch</sys_updated_by>
        <sys_updated_on>2020-06-17 01:49:15</sys_updated_on>
    </sys_hub_action_plan>
    <sys_hub_action_type_snapshot action="INSERT_OR_UPDATE">
        <access>public</access>
        <acls/>
        <action_template/>
        <annotation/>
        <callable_by_client_api>false</callable_by_client_api>
        <category/>
        <copied_from/>
        <copied_from_name/>
        <description/>
        <internal_name>worker_poll_destroy_workspace</internal_name>
        <label_cache>[{"name":"{{action.tf_record}}","label":"action➛tf_record","type":"action","ref":""}]</label_cache>
        <master>true</master>
        <name>Worker Poll Destroy Workspace</name>
        <natlang/>
        <outputs/>
        <parent_action display_value="Worker Poll Destroy Workspace">4e6332e3db99581038699d67b99619e2</parent_action>
        <sys_class_name>sys_hub_action_type_snapshot</sys_class_name>
        <sys_created_by>pwelch</sys_created_by>
        <sys_created_on>2020-06-15 20:31:43</sys_created_on>
        <sys_domain>global</sys_domain>
        <sys_domain_path>/</sys_domain_path>
        <sys_id>a9a376e3db99581038699d67b996190d</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_name/>
        <sys_overrides/>
        <sys_package/>
        <sys_policy/>
        <sys_scope display_value="Terraform">a3f7fe62dbe033009ba2f8fdbf96192a</sys_scope>
        <sys_update_name/>
        <sys_updated_by>pwelch</sys_updated_by>
        <sys_updated_on>2020-06-15 20:31:43</sys_updated_on>
        <system_level>false</system_level>
        <type/>
    </sys_hub_action_type_snapshot>
    <sys_translated_text action="delete_multiple" query="documentkey=a9a376e3db99581038699d67b996190d"/>
    <sys_variable_value action="delete_multiple" query="document_key=a9a376e3db99581038699d67b996190d"/>
    <sys_hub_step_instance action="delete_multiple" query="action=a9a376e3db99581038699d67b996190d^sys_idNOT IN2da376e3db99581038699d67b9961914"/>
    <sys_hub_step_instance action="INSERT_OR_UPDATE">
        <action display_value="Worker Poll Destroy Workspace">a9a376e3db99581038699d67b996190d</action>
        <cid>fa882b48-7ce6-4ebe-be67-abf2115bd35a</cid>
        <extended_inputs/>
        <extended_inputs/>
        <extended_outputs/>
        <icon/>
        <inputs/>
        <label>Script step</label>
        <order>1</order>
        <outputs/>
        <section/>
        <step_type display_value="Script">106afb6647032200b4fad7527c9a71e7</step_type>
        <sys_created_by>pwelch</sys_created_by>
        <sys_created_on>2020-06-15 20:31:43</sys_created_on>
        <sys_id>2da376e3db99581038699d67b9961914</sys_id>
        <sys_mod_count>4</sys_mod_count>
        <sys_scope display_value="Terraform">a3f7fe62dbe033009ba2f8fdbf96192a</sys_scope>
        <sys_updated_by>pwelch</sys_updated_by>
        <sys_updated_on>2020-06-17 01:49:14</sys_updated_on>
    </sys_hub_step_instance>
    <sys_variable_value action="delete_multiple" query="document_key=2da376e3db99581038699d67b9961914"/>
    <sys_variable_value action="INSERT_OR_UPDATE">
        <document>sys_hub_step_instance</document>
        <document_key>2da376e3db99581038699d67b9961914</document_key>
        <order>600</order>
        <sys_class_name>sys_variable_value</sys_class_name>
        <sys_created_by>pwelch</sys_created_by>
        <sys_created_on>2020-06-15 20:31:43</sys_created_on>
        <sys_id>ada376e3db99581038699d67b996191f</sys_id>
        <sys_mod_count>3</sys_mod_count>
        <sys_updated_by>pwelch</sys_updated_by>
        <sys_updated_on>2020-06-17 01:49:14</sys_updated_on>
        <value>(function execute(inputs, outputs) {
/*
  Poll Destroy Workspace
    Finds any records marked where is-destroyable = true and
    sends the destroy API requests to Terraform

    The "Delete Workspace" example flow catalog item will set the is_destroyable
    value, then create a terraform destroy plan.
    This flow will then check the state of the planning workspace.
    If it's done planning, it will apply the destroy run.
    If it's done applying the destroy run, it will delete the workspace from Terraform.
*/

gs.info("Polling Flow: terraform delete workspace started...");

// Input Variables
var tfRecord = inputs.tf_record;

// Create new objects from Terraform API SDK
var terraformRecord  = new tf_terraform_record();
var run              = new tf_run();
var workspace        = new tf_workspace();
var util             = new tf_util();

var tfCurrentRun = workspace.getWorkspaceCurrentRun(tfRecord.workspace_name);
  
if (tfCurrentRun !== null) {
  if (run.isDestroyRun(tfCurrentRun.id) !== "false") {
    var tfRunState   = run.getRunState(tfCurrentRun.id).toLowerCase();
    var comment = "";

    switch (tfRunState) {
      case "planning":
        // no-op: move on until it's done
        break;

      case "planned":
        /* Apply Run */
        // If the destroy run is finished planning, we can confirm and apply the destroy run.
        var applyContent = run.createRunRequestContent(workspaceID, "Destroy triggered by scheduler");
        var requestJSON  = JSON.stringify(applyContent);

        var http = new tf_http("TF Runs", "Apply Run", requestJSON);
        http.setParam("run_id", String(tfCurrentRun.id));
        http.execute();

        tfRecord.last_known_state = "destroy_applying";
        tfRecord.update();
        comment = util.formatCommentBlockQuote("Terraform: destroy run applying");
        break;

      case "applied": case "planned_and_finished":
        /* Delete Workspace */
        // The destroy run removing all resources managed by terraform is complete so we can delete the workspace.
        // HTTP REST request to Terraform Workspace API
        var httpWorkspace = new tf_http("TF Workspaces", "Delete Workspace", null);
        httpWorkspace.setParam("workspace_name", String(tfRecord.workspace_name));
        httpWorkspace.execute();

        tfRecord.last_known_state = "deleted";
        tfRecord.update();
        comment = util.formatCommentBlockQuote("Terraform: Workspace Deleted");
        break;

      case "applying":
        // no-op: move on until it's done
        break;

      case "discarded": case "errored": case "canceled":
        tfRecord.last_known_state = "errored";
        tfRecord.is_destroyable   = false;
        tfRecord.update();
        comment = util.formatCommentBlockQuote("Terraform: destroy error, resetting to not destroyable");
        break;
    }
    
    terraformRecord.postRITMComment(tfRecord.requested_item, comment);
  }
}
  
gs.info("Polling Flow: terraform delete workspace finished.");

})(inputs, outputs);
</value>
        <variable display_value="">71aa7f6647032200b4fad7527c9a719b</variable>
    </sys_variable_value>
    <sys_variable_value action="INSERT_OR_UPDATE">
        <document>sys_hub_step_instance</document>
        <document_key>2da376e3db99581038699d67b9961914</document_key>
        <order>400</order>
        <sys_class_name>sys_variable_value</sys_class_name>
        <sys_created_by>pwelch</sys_created_by>
        <sys_created_on>2020-06-15 20:31:43</sys_created_on>
        <sys_id>e9a376e3db99581038699d67b996191f</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_updated_by>pwelch</sys_updated_by>
        <sys_updated_on>2020-06-15 20:31:43</sys_updated_on>
        <value>35aa573fd7802200bdbaee5b5e610375</value>
        <variable display_value="">f5e56d79b3101300176b051a16a8dce4</variable>
    </sys_variable_value>
    <sys_element_mapping action="delete_multiple" query="id=2da376e3db99581038699d67b9961914"/>
    <sys_element_mapping action="INSERT_OR_UPDATE">
        <field>application</field>
        <id>2da376e3db99581038699d67b9961914</id>
        <sys_created_by>pwelch</sys_created_by>
        <sys_created_on>2020-06-15 20:31:43</sys_created_on>
        <sys_id>a5a376e3db99581038699d67b996191f</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_updated_by>pwelch</sys_updated_by>
        <sys_updated_on>2020-06-15 20:31:43</sys_updated_on>
        <table>var__m_sys_flow_step_definition_input_106afb6647032200b4fad7527c9a71e7</table>
        <value/>
    </sys_element_mapping>
    <sys_element_mapping action="INSERT_OR_UPDATE">
        <field>script</field>
        <id>2da376e3db99581038699d67b9961914</id>
        <sys_created_by>pwelch</sys_created_by>
        <sys_created_on>2020-06-15 20:31:43</sys_created_on>
        <sys_id>69a376e3db99581038699d67b996191f</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_updated_by>pwelch</sys_updated_by>
        <sys_updated_on>2020-06-15 20:31:43</sys_updated_on>
        <table>var__m_sys_flow_step_definition_input_106afb6647032200b4fad7527c9a71e7</table>
        <value/>
    </sys_element_mapping>
    <sys_element_mapping action="INSERT_OR_UPDATE">
        <field>tf_record</field>
        <id>2da376e3db99581038699d67b9961914</id>
        <sys_created_by>pwelch</sys_created_by>
        <sys_created_on>2020-06-15 20:31:43</sys_created_on>
        <sys_id>29a376e3db99581038699d67b9961920</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_updated_by>pwelch</sys_updated_by>
        <sys_updated_on>2020-06-15 20:31:43</sys_updated_on>
        <table>var__m_sys_hub_step_ext_input_2da376e3db99581038699d67b9961914</table>
        <value>{{action.tf_record}}</value>
    </sys_element_mapping>
    <sys_hub_step_ext_input action="delete_multiple" query="model=2da376e3db99581038699d67b9961914^sys_idNOT IN29a376e3db99581038699d67b9961917"/>
    <sys_hub_step_ext_input action="INSERT_OR_UPDATE">
        <active>true</active>
        <array>false</array>
        <array_denormalized>false</array_denormalized>
        <attributes>element_mapping_provider=com.glide.flow_design.action.data.FlowDesignVariableMapper,uiType=string</attributes>
        <audit>false</audit>
        <calculation><![CDATA[(function calculatedFieldValue(current) {

	// Add your code here
	return '';  // return the calculated value

})(current);]]></calculation>
        <choice/>
        <choice_field/>
        <choice_table/>
        <column_label/>
        <comments/>
        <create_roles/>
        <default_value/>
        <defaultsort/>
        <delete_roles/>
        <dependent/>
        <dependent_on_field/>
        <display>false</display>
        <dynamic_creation>false</dynamic_creation>
        <dynamic_creation_script/>
        <dynamic_default_value/>
        <dynamic_ref_qual/>
        <element>tf_record</element>
        <element_reference>false</element_reference>
        <foreign_database/>
        <function_definition/>
        <function_field>false</function_field>
        <help/>
        <hint/>
        <internal_type display_value="String">string</internal_type>
        <label>tf_record</label>
        <mandatory>true</mandatory>
        <max_length>8000</max_length>
        <model display_value="Script step">2da376e3db99581038699d67b9961914</model>
        <model_id>2da376e3db99581038699d67b9961914</model_id>
        <model_table>sys_hub_step_instance</model_table>
        <name>var__m_sys_hub_step_ext_input_2da376e3db99581038699d67b9961914</name>
        <next_element/>
        <order>0</order>
        <primary>false</primary>
        <read_only>false</read_only>
        <read_roles/>
        <reference/>
        <reference_cascade_rule/>
        <reference_floats>false</reference_floats>
        <reference_key/>
        <reference_qual/>
        <reference_qual_condition/>
        <reference_type/>
        <sizeclass/>
        <spell_check>false</spell_check>
        <staged>false</staged>
        <sys_class_name>sys_hub_step_ext_input</sys_class_name>
        <sys_created_by>pwelch</sys_created_by>
        <sys_created_on>2020-06-15 20:31:43</sys_created_on>
        <sys_id>29a376e3db99581038699d67b9961917</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_name/>
        <sys_package/>
        <sys_policy/>
        <sys_scope display_value="Terraform">a3f7fe62dbe033009ba2f8fdbf96192a</sys_scope>
        <sys_update_name/>
        <sys_updated_by>pwelch</sys_updated_by>
        <sys_updated_on>2020-06-15 20:31:43</sys_updated_on>
        <table_reference>false</table_reference>
        <text_index>false</text_index>
        <unique>false</unique>
        <use_dependent_field>false</use_dependent_field>
        <use_dynamic_default>false</use_dynamic_default>
        <use_reference_qualifier>simple</use_reference_qualifier>
        <virtual>false</virtual>
        <widget/>
        <write_roles/>
        <xml_view>false</xml_view>
    </sys_hub_step_ext_input>
    <sys_hub_action_input action="delete_multiple" query="model=a9a376e3db99581038699d67b996190d^sys_idNOT IN29a376e3db99581038699d67b996190e"/>
    <sys_hub_action_input action="INSERT_OR_UPDATE">
        <active>true</active>
        <array>false</array>
        <array_denormalized>false</array_denormalized>
        <attributes>element_mapping_provider=com.glide.flow_design.action.data.FlowDesignVariableMapper,uiType=string,uiTypeLabel=String</attributes>
        <audit>false</audit>
        <calculation><![CDATA[(function calculatedFieldValue(current) {

	// Add your code here
	return '';  // return the calculated value

})(current);]]></calculation>
        <choice/>
        <choice_field/>
        <choice_table/>
        <column_label/>
        <comments/>
        <create_roles/>
        <default_value/>
        <defaultsort/>
        <delete_roles/>
        <dependent/>
        <dependent_on_field/>
        <display>false</display>
        <dynamic_creation>false</dynamic_creation>
        <dynamic_creation_script/>
        <dynamic_default_value/>
        <dynamic_ref_qual/>
        <element>tf_record</element>
        <element_reference>false</element_reference>
        <foreign_database/>
        <function_definition/>
        <function_field>false</function_field>
        <help/>
        <hint/>
        <internal_type display_value="String">string</internal_type>
        <label>tf_record</label>
        <mandatory>false</mandatory>
        <max_length>8000</max_length>
        <model display_value="Worker Poll Destroy Workspace">a9a376e3db99581038699d67b996190d</model>
        <model_id>a9a376e3db99581038699d67b996190d</model_id>
        <model_table>sys_hub_action_type_snapshot</model_table>
        <name>var__m_sys_hub_action_input_a9a376e3db99581038699d67b996190d</name>
        <next_element/>
        <order>1</order>
        <primary>false</primary>
        <read_only>false</read_only>
        <read_roles/>
        <reference/>
        <reference_cascade_rule/>
        <reference_floats>false</reference_floats>
        <reference_key/>
        <reference_qual/>
        <reference_qual_condition/>
        <reference_type/>
        <sizeclass/>
        <spell_check>false</spell_check>
        <staged>false</staged>
        <sys_class_name>sys_hub_action_input</sys_class_name>
        <sys_created_by>pwelch</sys_created_by>
        <sys_created_on>2020-06-15 20:31:43</sys_created_on>
        <sys_id>29a376e3db99581038699d67b996190e</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_name/>
        <sys_package/>
        <sys_policy/>
        <sys_scope display_value="Terraform">a3f7fe62dbe033009ba2f8fdbf96192a</sys_scope>
        <sys_update_name/>
        <sys_updated_by>pwelch</sys_updated_by>
        <sys_updated_on>2020-06-15 20:31:43</sys_updated_on>
        <table_reference>false</table_reference>
        <text_index>false</text_index>
        <unique>false</unique>
        <use_dependent_field>false</use_dependent_field>
        <use_dynamic_default>false</use_dynamic_default>
        <use_reference_qualifier>simple</use_reference_qualifier>
        <virtual>false</virtual>
        <widget/>
        <write_roles/>
        <xml_view>false</xml_view>
    </sys_hub_action_input>
    <sys_hub_step_instance action="delete_multiple" query="action=a9a376e3db99581038699d67b996190d^sys_idNOT IN2da376e3db99581038699d67b9961914"/>
    <sys_hub_step_instance action="INSERT_OR_UPDATE">
        <action display_value="Worker Poll Destroy Workspace">a9a376e3db99581038699d67b996190d</action>
        <cid>fa882b48-7ce6-4ebe-be67-abf2115bd35a</cid>
        <extended_inputs/>
        <extended_inputs/>
        <extended_outputs/>
        <icon/>
        <inputs/>
        <label>Script step</label>
        <order>1</order>
        <outputs/>
        <section/>
        <step_type display_value="Script">106afb6647032200b4fad7527c9a71e7</step_type>
        <sys_created_by>pwelch</sys_created_by>
        <sys_created_on>2020-06-15 20:31:43</sys_created_on>
        <sys_id>2da376e3db99581038699d67b9961914</sys_id>
        <sys_mod_count>4</sys_mod_count>
        <sys_scope display_value="Terraform">a3f7fe62dbe033009ba2f8fdbf96192a</sys_scope>
        <sys_updated_by>pwelch</sys_updated_by>
        <sys_updated_on>2020-06-17 01:49:14</sys_updated_on>
    </sys_hub_step_instance>
    <sys_variable_value action="delete_multiple" query="document_key=2da376e3db99581038699d67b9961914"/>
    <sys_variable_value action="INSERT_OR_UPDATE">
        <document>sys_hub_step_instance</document>
        <document_key>2da376e3db99581038699d67b9961914</document_key>
        <order>600</order>
        <sys_class_name>sys_variable_value</sys_class_name>
        <sys_created_by>pwelch</sys_created_by>
        <sys_created_on>2020-06-15 20:31:43</sys_created_on>
        <sys_id>ada376e3db99581038699d67b996191f</sys_id>
        <sys_mod_count>3</sys_mod_count>
        <sys_updated_by>pwelch</sys_updated_by>
        <sys_updated_on>2020-06-17 01:49:14</sys_updated_on>
        <value>(function execute(inputs, outputs) {
/*
  Poll Destroy Workspace
    Finds any records marked where is-destroyable = true and
    sends the destroy API requests to Terraform

    The "Delete Workspace" example flow catalog item will set the is_destroyable
    value, then create a terraform destroy plan.
    This flow will then check the state of the planning workspace.
    If it's done planning, it will apply the destroy run.
    If it's done applying the destroy run, it will delete the workspace from Terraform.
*/

gs.info("Polling Flow: terraform delete workspace started...");

// Input Variables
var tfRecord = inputs.tf_record;

// Create new objects from Terraform API SDK
var terraformRecord  = new tf_terraform_record();
var run              = new tf_run();
var workspace        = new tf_workspace();
var util             = new tf_util();

var tfCurrentRun = workspace.getWorkspaceCurrentRun(tfRecord.workspace_name);
  
if (tfCurrentRun !== null) {
  if (run.isDestroyRun(tfCurrentRun.id) !== "false") {
    var tfRunState   = run.getRunState(tfCurrentRun.id).toLowerCase();
    var comment = "";

    switch (tfRunState) {
      case "planning":
        // no-op: move on until it's done
        break;

      case "planned":
        /* Apply Run */
        // If the destroy run is finished planning, we can confirm and apply the destroy run.
        var applyContent = run.createRunRequestContent(workspaceID, "Destroy triggered by scheduler");
        var requestJSON  = JSON.stringify(applyContent);

        var http = new tf_http("TF Runs", "Apply Run", requestJSON);
        http.setParam("run_id", String(tfCurrentRun.id));
        http.execute();

        tfRecord.last_known_state = "destroy_applying";
        tfRecord.update();
        comment = util.formatCommentBlockQuote("Terraform: destroy run applying");
        break;

      case "applied": case "planned_and_finished":
        /* Delete Workspace */
        // The destroy run removing all resources managed by terraform is complete so we can delete the workspace.
        // HTTP REST request to Terraform Workspace API
        var httpWorkspace = new tf_http("TF Workspaces", "Delete Workspace", null);
        httpWorkspace.setParam("workspace_name", String(tfRecord.workspace_name));
        httpWorkspace.execute();

        tfRecord.last_known_state = "deleted";
        tfRecord.update();
        comment = util.formatCommentBlockQuote("Terraform: Workspace Deleted");
        break;

      case "applying":
        // no-op: move on until it's done
        break;

      case "discarded": case "errored": case "canceled":
        tfRecord.last_known_state = "errored";
        tfRecord.is_destroyable   = false;
        tfRecord.update();
        comment = util.formatCommentBlockQuote("Terraform: destroy error, resetting to not destroyable");
        break;
    }
    
    terraformRecord.postRITMComment(tfRecord.requested_item, comment);
  }
}
  
gs.info("Polling Flow: terraform delete workspace finished.");

})(inputs, outputs);
</value>
        <variable display_value="">71aa7f6647032200b4fad7527c9a719b</variable>
    </sys_variable_value>
    <sys_variable_value action="INSERT_OR_UPDATE">
        <document>sys_hub_step_instance</document>
        <document_key>2da376e3db99581038699d67b9961914</document_key>
        <order>400</order>
        <sys_class_name>sys_variable_value</sys_class_name>
        <sys_created_by>pwelch</sys_created_by>
        <sys_created_on>2020-06-15 20:31:43</sys_created_on>
        <sys_id>e9a376e3db99581038699d67b996191f</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_updated_by>pwelch</sys_updated_by>
        <sys_updated_on>2020-06-15 20:31:43</sys_updated_on>
        <value>35aa573fd7802200bdbaee5b5e610375</value>
        <variable display_value="">f5e56d79b3101300176b051a16a8dce4</variable>
    </sys_variable_value>
    <sys_element_mapping action="delete_multiple" query="id=2da376e3db99581038699d67b9961914"/>
    <sys_element_mapping action="INSERT_OR_UPDATE">
        <field>application</field>
        <id>2da376e3db99581038699d67b9961914</id>
        <sys_created_by>pwelch</sys_created_by>
        <sys_created_on>2020-06-15 20:31:43</sys_created_on>
        <sys_id>a5a376e3db99581038699d67b996191f</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_updated_by>pwelch</sys_updated_by>
        <sys_updated_on>2020-06-15 20:31:43</sys_updated_on>
        <table>var__m_sys_flow_step_definition_input_106afb6647032200b4fad7527c9a71e7</table>
        <value/>
    </sys_element_mapping>
    <sys_element_mapping action="INSERT_OR_UPDATE">
        <field>script</field>
        <id>2da376e3db99581038699d67b9961914</id>
        <sys_created_by>pwelch</sys_created_by>
        <sys_created_on>2020-06-15 20:31:43</sys_created_on>
        <sys_id>69a376e3db99581038699d67b996191f</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_updated_by>pwelch</sys_updated_by>
        <sys_updated_on>2020-06-15 20:31:43</sys_updated_on>
        <table>var__m_sys_flow_step_definition_input_106afb6647032200b4fad7527c9a71e7</table>
        <value/>
    </sys_element_mapping>
    <sys_element_mapping action="INSERT_OR_UPDATE">
        <field>tf_record</field>
        <id>2da376e3db99581038699d67b9961914</id>
        <sys_created_by>pwelch</sys_created_by>
        <sys_created_on>2020-06-15 20:31:43</sys_created_on>
        <sys_id>29a376e3db99581038699d67b9961920</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_updated_by>pwelch</sys_updated_by>
        <sys_updated_on>2020-06-15 20:31:43</sys_updated_on>
        <table>var__m_sys_hub_step_ext_input_2da376e3db99581038699d67b9961914</table>
        <value>{{action.tf_record}}</value>
    </sys_element_mapping>
    <sys_hub_step_ext_input action="delete_multiple" query="model=2da376e3db99581038699d67b9961914^sys_idNOT IN29a376e3db99581038699d67b9961917"/>
    <sys_hub_step_ext_input action="INSERT_OR_UPDATE">
        <active>true</active>
        <array>false</array>
        <array_denormalized>false</array_denormalized>
        <attributes>element_mapping_provider=com.glide.flow_design.action.data.FlowDesignVariableMapper,uiType=string</attributes>
        <audit>false</audit>
        <calculation><![CDATA[(function calculatedFieldValue(current) {

	// Add your code here
	return '';  // return the calculated value

})(current);]]></calculation>
        <choice/>
        <choice_field/>
        <choice_table/>
        <column_label/>
        <comments/>
        <create_roles/>
        <default_value/>
        <defaultsort/>
        <delete_roles/>
        <dependent/>
        <dependent_on_field/>
        <display>false</display>
        <dynamic_creation>false</dynamic_creation>
        <dynamic_creation_script/>
        <dynamic_default_value/>
        <dynamic_ref_qual/>
        <element>tf_record</element>
        <element_reference>false</element_reference>
        <foreign_database/>
        <function_definition/>
        <function_field>false</function_field>
        <help/>
        <hint/>
        <internal_type display_value="String">string</internal_type>
        <label>tf_record</label>
        <mandatory>true</mandatory>
        <max_length>8000</max_length>
        <model display_value="Script step">2da376e3db99581038699d67b9961914</model>
        <model_id>2da376e3db99581038699d67b9961914</model_id>
        <model_table>sys_hub_step_instance</model_table>
        <name>var__m_sys_hub_step_ext_input_2da376e3db99581038699d67b9961914</name>
        <next_element/>
        <order>0</order>
        <primary>false</primary>
        <read_only>false</read_only>
        <read_roles/>
        <reference/>
        <reference_cascade_rule/>
        <reference_floats>false</reference_floats>
        <reference_key/>
        <reference_qual/>
        <reference_qual_condition/>
        <reference_type/>
        <sizeclass/>
        <spell_check>false</spell_check>
        <staged>false</staged>
        <sys_class_name>sys_hub_step_ext_input</sys_class_name>
        <sys_created_by>pwelch</sys_created_by>
        <sys_created_on>2020-06-15 20:31:43</sys_created_on>
        <sys_id>29a376e3db99581038699d67b9961917</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_name/>
        <sys_package/>
        <sys_policy/>
        <sys_scope display_value="Terraform">a3f7fe62dbe033009ba2f8fdbf96192a</sys_scope>
        <sys_update_name/>
        <sys_updated_by>pwelch</sys_updated_by>
        <sys_updated_on>2020-06-15 20:31:43</sys_updated_on>
        <table_reference>false</table_reference>
        <text_index>false</text_index>
        <unique>false</unique>
        <use_dependent_field>false</use_dependent_field>
        <use_dynamic_default>false</use_dynamic_default>
        <use_reference_qualifier>simple</use_reference_qualifier>
        <virtual>false</virtual>
        <widget/>
        <write_roles/>
        <xml_view>false</xml_view>
    </sys_hub_step_ext_input>
    <sys_documentation action="delete_multiple" query="name=var__m_sys_hub_action_input_a9a376e3db99581038699d67b996190d^sys_idNOT IN61a376e3db99581038699d67b9961913"/>
    <sys_documentation action="INSERT_OR_UPDATE">
        <element>tf_record</element>
        <help/>
        <hint/>
        <label>tf_record</label>
        <language>en</language>
        <name>var__m_sys_hub_action_input_a9a376e3db99581038699d67b996190d</name>
        <plural/>
        <sys_class_name>sys_documentation</sys_class_name>
        <sys_created_by>pwelch</sys_created_by>
        <sys_created_on>2020-06-15 20:31:43</sys_created_on>
        <sys_id>61a376e3db99581038699d67b9961913</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_name>tf_record</sys_name>
        <sys_package display_value="Terraform" source="x_325709_terraform">a3f7fe62dbe033009ba2f8fdbf96192a</sys_package>
        <sys_policy/>
        <sys_scope display_value="Terraform">a3f7fe62dbe033009ba2f8fdbf96192a</sys_scope>
        <sys_update_name>sys_documentation_var__m_sys_hub_action_input_a9a376e3db99581038699d67b996190d_tf_record_en</sys_update_name>
        <sys_updated_by>pwelch</sys_updated_by>
        <sys_updated_on>2020-06-15 20:31:43</sys_updated_on>
        <url/>
        <url_target/>
    </sys_documentation>
</record_update>
